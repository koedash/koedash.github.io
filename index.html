<!DOCTYPE html>
<html>
<head>
  <title>Library Helper</title>
  <style>
    :root { 
      --bg-color: #f0f8ff; 
      --button-bg: rgba(255, 255, 255, 0.7);
      --bg-image: none;
      --bg-opacity: 0.8;
      --bg-blur: 0px;
    }
    body { 
      font-family: Arial; 
      margin: 20px; 
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-color) var(--bg-image);
      background-size: cover;
      background-position: center;
      opacity: var(--bg-opacity);
      filter: blur(var(--bg-blur));
      z-index: -1;
    }
    
    /* Main Menu */
    .main-menu {
      text-align: center;
      margin: 20px 0;
    }
    
    .main-menu h1 {
      margin-bottom: 20px;
    }
    
    .main-menu button {
      background: var(--button-bg);
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 20px;
      margin: 0 10px;
      cursor: pointer;
      font-size: 1em;
    }
    
    /* Modal Windows */
    .modal-window {
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: rgba(255,255,255,0.95); 
      padding: 20px; 
      box-shadow: 0 0 20px rgba(0,0,0,0.2); 
      z-index: 1000;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Rental Interface */
    #rentalInterface h2 {
      margin-top: 0;
      text-align: center;
    }
    
    .filter-options {
      margin: 15px 0;
      text-align: center;
    }
    
    .filter-options span {
      cursor: pointer;
      padding: 0 5px;
    }
    
    .input-box {
      margin: 15px 0;
      display: flex;
      align-items: center;
    }
    
    .input-label {
      width: 80px;
      font-weight: bold;
    }
    
    input {
      padding: 8px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    
    #rentalList {
      max-height: 200px;
      overflow-y: auto;
      margin: 15px 0;
      border: 1px solid #eee;
      padding: 5px;
    }
    
    #rentalList div {
      margin: 5px 0;
      padding: 5px;
      background: rgba(0,0,0,0.05);
      font-family: monospace;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .delete-btn {
      color: #ff4444;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 0 5px;
    }
    
    .action-buttons {
      margin-top: 15px;
      text-align: center;
    }
    
    button {
      background: var(--button-bg);
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px 15px;
      margin: 0 5px;
      cursor: pointer;
    }
    
    /* Settings Panel Specific */
    .settings-row {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      align-items: center;
    }
    
    .settings-row label {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    
    #bgPreview {
      width: 100px;
      height: 100px;
      border: 1px solid #ccc;
      margin-top: 5px;
      background-size: cover;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Overlay when modal is open */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
  <!-- Main Menu (always visible) -->
  <div class="main-menu">
    <h1>Library Helper</h1>
    <button id="rentalBtn">Manage Rentals</button>
    <button id="settingsBtn">Settings</button>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay"></div>

  <!-- Rental Interface Modal -->
  <div class="modal-window" id="rentalInterface">
    <h2>Rental Tracker</h2>
    
    <div class="filter-options">
      <span id="todayBtn">Today (<span id="todayCount">0</span>)</span> | 
      <span id="weekBtn">This Week (<span id="weekCount">0</span>)</span> | 
      <span id="monthBtn">This Month (<span id="monthCount">0</span>)</span>
    </div>
    
    <div id="rentalList"><p>No rentals yet</p></div>
    
    <div class="input-box">
      <div class="input-label">Book ID:</div>
      <input type="text" id="bookId" placeholder="Scan or type">
    </div>
    
    <div class="input-box">
      <div class="input-label">Student ID:</div>
      <input type="text" id="studentId" placeholder="Scan or type">
    </div>
    
    <div class="action-buttons">
      <button id="processBtn">Process Rental</button>
      <button id="closeRentalBtn">Close</button>
    </div>
  </div>

  <!-- Settings Panel Modal -->
  <div class="modal-window" id="settingsPanel">
    <h2>Settings</h2>
    
    <div class="settings-row">
      <label>
        Background Color:
        <input type="color" id="bgColor" value="#f0f8ff">
      </label>
      
      <label>
        Background Image:
        <input type="file" id="bgImageUpload" accept="image/*">
        <div id="bgPreview"></div>
      </label>
    </div>
    
    <div class="settings-row">
      <label>
        Image Opacity:
        <div class="slider-container">
          <input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0.8">
          <span id="opacityValue">80%</span>
        </div>
      </label>
      
      <label>
        Blur Effect:
        <div class="slider-container">
          <input type="range" id="bgBlur" min="0" max="20" value="0">
          <span id="blurValue">0px</span>
        </div>
      </label>
    </div>
    
    <div class="action-buttons">
      <button id="saveBtn">Save</button>
      <button id="resetBgBtn">Reset Background</button>
      <button id="closeSettingsBtn">Close</button>
    </div>
  </div>

  <script>
    // Scanner Logic
    const setupScanner = (inputId) => {
      let lastValue = '';
      let lastInputTime = 0;
      let isScannerInput = false;
      let timeout;

      document.getElementById(inputId).addEventListener('input', function(e) {
        clearTimeout(timeout);
        const now = Date.now();
        const timeSinceLastInput = now - lastInputTime;
        
        isScannerInput = timeSinceLastInput < 30 && this.value.length > lastValue.length;
        lastInputTime = now;
        lastValue = this.value;

        if (isScannerInput) {
          timeout = setTimeout(() => {
            if (this.value === lastValue) {
              this.value = '';
            }
          }, 50);
        }
      });
    };

    // Modal Window Control
    function openModal(modalId) {
      // Close any open modal first
      document.querySelectorAll('.modal-window').forEach(modal => {
        modal.style.display = 'none';
      });
      
      // Show overlay and the requested modal
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById(modalId).style.display = 'block';
      
      // Update counts when opening rental interface
      if (modalId === 'rentalInterface') {
        updateFilterCounts();
      }
    }

    function closeModals() {
      document.getElementById('modalOverlay').style.display = 'none';
      document.querySelectorAll('.modal-window').forEach(modal => {
        modal.style.display = 'none';
      });
    }

    // Update filter counts
    function updateFilterCounts() {
      const rentals = JSON.parse(localStorage.getItem('rentals')) || [];
      const now = new Date();
      
      // Today count
      const todayCount = rentals.filter(r => {
        const rentalDate = new Date(r.date);
        return rentalDate.toDateString() === now.toDateString();
      }).length;
      document.getElementById('todayCount').textContent = todayCount;
      
      // Week count
      const weekCount = rentals.filter(r => {
        const rentalDate = new Date(r.date);
        return (now - rentalDate) <= 604800000;
      }).length;
      document.getElementById('weekCount').textContent = weekCount;
      
      // Month count
      const monthCount = rentals.filter(r => {
        const rentalDate = new Date(r.date);
        return rentalDate.getMonth() === now.getMonth();
      }).length;
      document.getElementById('monthCount').textContent = monthCount;
    }

    // Delete rental function
    function deleteRental(bookId, studentId) {
      let rentals = JSON.parse(localStorage.getItem('rentals')) || [];
      rentals = rentals.filter(r => !(r.bookId === bookId && r.studentId === studentId));
      localStorage.setItem('rentals', JSON.stringify(rentals));
      updateRentalList(document.getElementById('rentalInterface').dataset.currentFilter || 'day');
      updateFilterCounts();
    }

    // Core Application
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize scanners
      setupScanner('bookId');
      setupScanner('studentId');

      // Load saved settings
      const savedColor = localStorage.getItem('bgColor') || '#f0f8ff';
      const savedImage = localStorage.getItem('bgImage') || 'none';
      const savedOpacity = localStorage.getItem('bgOpacity') || '0.8';
      const savedBlur = localStorage.getItem('bgBlur') || '0';

      // Apply saved settings
      document.body.style.setProperty('--bg-color', savedColor);
      document.body.style.setProperty('--bg-image', savedImage);
      document.body.style.setProperty('--bg-opacity', savedOpacity);
      document.body.style.setProperty('--bg-blur', savedBlur + 'px');
      
      // Update UI controls
      document.getElementById('bgColor').value = savedColor;
      document.getElementById('bgOpacity').value = savedOpacity;
      document.getElementById('bgBlur').value = savedBlur;
      document.getElementById('opacityValue').textContent = Math.round(savedOpacity * 100) + '%';
      document.getElementById('blurValue').textContent = savedBlur + 'px';
      
      if (savedImage !== 'none') {
        document.getElementById('bgPreview').style.backgroundImage = savedImage;
      }

      // Event listeners for sliders
      document.getElementById('bgOpacity').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('opacityValue').textContent = Math.round(value * 100) + '%';
      });

      document.getElementById('bgBlur').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('blurValue').textContent = value + 'px';
      });

      // Image upload preview
      document.getElementById('bgImageUpload').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const url = `url(${event.target.result})`;
            document.getElementById('bgPreview').style.backgroundImage = url;
          };
          reader.readAsDataURL(e.target.files[0]);
        }
      });

      // Main menu buttons
      document.getElementById('rentalBtn').addEventListener('click', function() {
        openModal('rentalInterface');
      });

      document.getElementById('settingsBtn').addEventListener('click', function() {
        openModal('settingsPanel');
      });

      // Filter buttons
      document.getElementById('todayBtn').addEventListener('click', function() {
        updateRentalList('day');
      });

      document.getElementById('weekBtn').addEventListener('click', function() {
        updateRentalList('week');
      });

      document.getElementById('monthBtn').addEventListener('click', function() {
        updateRentalList('month');
      });

      // Process rental button
      document.getElementById('processBtn').addEventListener('click', processRental);

      // Close buttons
      document.getElementById('closeRentalBtn').addEventListener('click', closeModals);
      document.getElementById('closeSettingsBtn').addEventListener('click', closeModals);
      
      // Close modal when clicking overlay
      document.getElementById('modalOverlay').addEventListener('click', closeModals);

      // Initialize rental data
      let rentals = JSON.parse(localStorage.getItem('rentals')) || [];
      updateRentalList('day');
      updateFilterCounts();
    });

    function updateRentalList(range) {
      const rentals = JSON.parse(localStorage.getItem('rentals')) || [];
      const now = new Date();
      const filtered = rentals.filter(rental => {
        const rentalDate = new Date(rental.date);
        switch (range) {
          case 'day': return rentalDate.toDateString() === now.toDateString();
          case 'week': return (now - rentalDate) <= 604800000;
          case 'month': return rentalDate.getMonth() === now.getMonth();
          default: return true;
        }
      });
      
      const listEl = document.getElementById('rentalList');
      if (filtered.length) {
        listEl.innerHTML = filtered.map(r => `
          <div>
            <span>Book ID: ${r.bookId} → Student ID: ${r.studentId} (${r.date.split('T')[0]})</span>
            <button class="delete-btn" onclick="deleteRental('${r.bookId}', '${r.studentId}')">X</button>
          </div>
        `).join('');
      } else {
        listEl.innerHTML = '<p>No rentals found</p>';
      }
      
      // Store current filter
      document.getElementById('rentalInterface').dataset.currentFilter = range;
    }

    function processRental() {
      const bookId = document.getElementById('bookId').value.trim();
      const studentId = document.getElementById('studentId').value.trim();
      
      if (bookId && studentId) {
        let rentals = JSON.parse(localStorage.getItem('rentals')) || [];
        
        // Remove existing entries with these IDs
        rentals = rentals.filter(r => !(r.bookId === bookId || r.studentId === studentId));
        
        // Add new rental
        rentals.push({
          bookId,
          studentId,
          date: new Date().toISOString()
        });
        
        // Save and update
        localStorage.setItem('rentals', JSON.stringify(rentals));
        updateRentalList(document.getElementById('rentalInterface').dataset.currentFilter || 'day');
        updateFilterCounts();
        document.getElementById('bookId').value = '';
        document.getElementById('studentId').value = '';
      } else {
        alert('Please enter both IDs!');
      }
    }

    function saveSettings() {
      // Save color
      const color = document.getElementById('bgColor').value;
      document.body.style.setProperty('--bg-color', color);
      localStorage.setItem('bgColor', color);
      
      // Save image if uploaded
      const bgImageUpload = document.getElementById('bgImageUpload');
      if (bgImageUpload.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const bgImage = `url(${e.target.result})`;
          document.body.style.setProperty('--bg-image', bgImage);
          localStorage.setItem('bgImage', bgImage);
        };
        reader.readAsDataURL(bgImageUpload.files[0]);
      }
      
      // Save opacity and blur
      const opacity = document.getElementById('bgOpacity').value;
      const blur = document.getElementById('bgBlur').value;
      document.body.style.setProperty('--bg-opacity', opacity);
      document.body.style.setProperty('--bg-blur', blur + 'px');
      localStorage.setItem('bgOpacity', opacity);
      localStorage.setItem('bgBlur', blur);
      
      closeModals();
    }

    function resetBackground() {
      localStorage.removeItem('bgImage');
      localStorage.removeItem('bgOpacity');
      localStorage.removeItem('bgBlur');
      document.body.style.setProperty('--bg-image', 'none');
      document.body.style.setProperty('--bg-opacity', '1');
      document.body.style.setProperty('--bg-blur', '0px');
      document.getElementById('bgPreview').style.backgroundImage = 'none';
      document.getElementById('bgOpacity').value = '0.8';
      document.getElementById('bgBlur').value = '0';
      document.getElementById('opacityValue').textContent = '80%';
      document.getElementById('blurValue').textContent = '0px';
      document.getElementById('bgImageUpload').value = '';
    }
  </script>
</body>
</html>
